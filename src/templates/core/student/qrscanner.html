{% extends "core/sidebar.html" %}

{% block body %}

<div class="text-center">
    <h1 class="h3 mb-4"><strong> QR Scanner</strong></h1>
    <p>For online classes. Scan the QR code provided by your instructor to log your attendance.</p>

    <div id="reader" style="display: inline-block; position: relative; padding: 0px; border: 1px solid silver; border-radius: 10px; width: 280px;"></div>

    <br><br>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    let html5QrcodeScanner = new Html5QrcodeScanner(
    "reader",
    { fps: 10, qrbox: { width: 175, height: 175 } }, 
    verbose=true
);

    var lastResult = '';
    var audio = new Audio('https://audio.jukehost.co.uk/knEZ8zciYnwmdVPG1W72H5SbFDIanomR');

    function onScanSuccess(decodedText) {
        // TODO: if (decodedText !== lastResult && [VALIDQRCODECHECKER]) {
            console.log(`Code matched ${decodedText}`);
            // TODO: get_qr(decodedText, selectedValue); // REPLACE WITH ACTUAL LOGIC

            lastResult = decodedText;
            audio.play();
        }
        else {
            //alert('Please scan a valid QR code!');
        }
    
    function onScanFailure(error) {
        console.warn(`Code scan error = ${error}`);
    }

    function get_qr(decodedText, selectedValue) {
        var s = [decodedText, isLate, selectedValue];
        var s_json = JSON.stringify(s);
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/get_qr", true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.onreadystatechange = function () {
            console.log(`Ready State: ${this.readyState}, Status: ${this.status}, s: ${s}, s_json: ${s_json}, isLate: ${isLate}`);
        };
        xhttp.send(s_json);
    }

    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>

<style>
    #html5-qrcode-button-camera-start {
        background-color: #800000;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
       
    }
    #html5-qrcode-button-camera-stop {
        background-color: #800000;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    #html5-qrcode-anchor-scan-type-change{
        margin-top: 10px;
        font-size: 15px;
    }
    #html5-qrcode-button-camera-permission{
    background-color: #800000;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 150px;
    }
</style>


{% endblock %}