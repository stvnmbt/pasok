{% extends "core/faculty/sidebar.html" %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

{% block body %}
<h1 class="h3 mb-4"><strong>Class List</strong></h1>

<!-- Form for school year and semester -->
<form id="classlistForm" style="margin-bottom: 20px;">
    <label for="school_year">Select School Year:</label>
    <select id="school_year" name="school_year">
        {% for year in range(2023, 2030) %}
            <option value="{{ year }}">{{ year }}</option>
        {% endfor %}
    </select>
    <label for="semester">Select Semester:</label>
    <select id="semester" name="semester">
        <option value="FIRST">First</option>
        <option value="SECOND">Second</option>
        <option value="SUMMER">Summer</option>
    </select>
    <!-- Add the submit button -->
    <input type="button" value="Submit" onclick="handleFileUpload()">
</form>

    <div class="row">
        <div class="col-auto">
            <!-- File upload section -->
            <input type="file" id="classListFile" accept=".csv, .xlsx" style="display: none;" multiple>
            <button class="btn btn-sm" onclick="uploadClassList()" style="background-color:#800000; color: white;">Upload Class List</button>
        </div>
    </div>


    <!-- Display a list of class lists with links to view details -->
    <h2 class="h4 mb-4"><strong>Class List Collection</strong></h2>
    <ul>
        {% for classlist_entry in classlist_data %}
            <li>
                {{ classlist_entry.subject_name }} - {{ classlist_entry.section_name }}
                <a href="{{ url_for('core.display_classlist', classlist_id=classlist_entry.id) }}">View Details</a>
                <a href="{{ url_for('core.delete_classlist', classlist_id=classlist_entry.id) }}" class="btn btn-danger">Delete</a>
            </li>
        {% endfor %}
    </ul>


    <script src="core.classlist.html" data-classlist-id="{{ classlistId|default(0) }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    
    <script>
        var classlistIdJson = '{{ classlistId_json|safe }}';
        var classlistId;

        if (classlistIdJson) {
            classlistId = JSON.parse(classlistIdJson);
            console.log('Classlist ID:', classlistId);
        } else {
            console.log('Classlist ID is undefined or null.');
        }

        function createFileEntry(filename, hasClasslist, classlistId) {
            var filesList = document.getElementById('uploadedFilesList');
            var fileEntry = document.createElement('div');
            fileEntry.className = 'file-entry';
            fileEntry.innerHTML = '<p>' + filename + '</p>' +
                '<button onclick="viewFileData(\'' + filename + '\')">View Data</button>';
            
            if (hasClasslist) {
                var viewClasslistUrl = '{{ url_for("core.classlist", classlist_id=classlistId) }}';
                fileEntry.innerHTML += '<a href="' + viewClasslistUrl + '" target="_blank">View Classlist</a>';
            }
    
            filesList.appendChild(fileEntry);
        }
    
        function uploadClassList() {
            // Trigger the click event on the hidden file input
            document.getElementById('classListFile').click();
        }
    
        // Update this function to handle the file upload and trigger the Flask route
        function handleFileUpload() {
            var fileInput = document.getElementById('classListFile');
            var schoolYear = document.getElementById('school_year').value;
            var semester = document.getElementById('semester').value;
    
            var formData = new FormData();
    
            // Add the selected files to the FormData object
            for (var i = 0; i < fileInput.files.length; i++) {
                formData.append('files[]', fileInput.files[i]);
            }
    
            // Add school_year and semester to the FormData object
            formData.append('school_year', schoolYear);
            formData.append('semester', semester);
    
            // Use fetch to send a POST request to the Flask route
            fetch('/upload_classlist', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Handle the response
                if ('files' in data) {
                    // Display uploaded files
                    data.files.forEach(function(filename) {
                        var hasClasslist = '{{ filename in classlists_by_user[current_user.id] }}' === 'True';
                        var classlistId = classlists_by_user[current_user.id][filename];
                        createFileEntry(filename, hasClasslist, classlistId);
                    });
                } else if ('error' in data) {
                    console.error('Error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    
        function viewFileData(filename) {
            // Use fetch to get the file data
            fetch('/data/' + filename, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                // Handle the response
                if ('data' in data) {
                    // Display the file data
                    console.log(data.data);  // Replace with your logic to display the data
                } else if ('error' in data) {
                    console.error('Error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
{% endblock %}

