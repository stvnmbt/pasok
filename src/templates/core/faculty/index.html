{% extends "core/faculty/sidebar.html" %}

{% block header %}
<script src="..\..\..\static\js\loader.js"></script>
<script>
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        var data = google.visualization.arrayToDataTable([
            ['Status', 'Count', { role: 'style' }],
            ['Present', 10, 'green'],
            ['Late', 5, 'orange'],
            ['Absent', 3, 'red'],
        ]);

        var options = {
            title: ' ',
        };

        var chart = new google.visualization.PieChart(document.getElementById('google-pie-chart'));

        chart.draw(data, options);
    }

    function downloadAction(subject, section) {
        $.ajax({
            url: `/export_attendance_excel/${subject}/${section}`,
            method: 'GET',
            success: function (data) {
                var blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                var link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = `attendance_records_${subject}_${section}.xlsx`;
                link.click();
            },
            error: function (xhr, status, error) {
                console.error(`Error downloading attendance records for subject ${subject} and section ${section}:`, error);
                alert(`Failed to download attendance records for subject ${subject} and section ${section}. Please try again later.`);
            }
        });
    }

    function deleteAction(subject, section) {
        if (confirm(`Are you sure you want to delete this record?\nSubject: ${subject}\nSection: ${section}`)) {
            $.ajax({
                url: `/delete_attendance_record/${subject}/${section}`,
                method: 'DELETE',
                success: function () {
                    location.reload(); // Reload the page after successful deletion
                },
                error: function (xhr, status, error) {
                    console.error(`Error deleting record for subject ${subject} and section ${section}:`, error);
                    alert(`Failed to delete record for subject ${subject} and section ${section}. Please try again later.`);
                }
            });
        }
    }
</script>
{% endblock %}

{% block body %}
<h1 class="h3 mb-4"><strong> Dashboard</strong></h1>

<div class="row">
    <div class="col-auto">
        <select class="form-select form-select-sm" style="width: 120px; height: 35px;">
            <option selected>School Year</option>
            <option value="1">2023</option>
            <option value="2">2024</option>
            <option value="3">2025</option>
        </select>
    </div>
    <div class="col-auto" style="margin-right: 60px;">
        <select class="form-select form-select-sm" style="width: 120px; height: 35px;">
            <option selected>Semester</option>
            <option value="1">First Sem</option>
            <option value="2">Second Sem</option>
        </select>
    </div>
</div>

<div id="google-pie-chart" style="width: 30%; height: 300px;"></div>

<table class="table datatables table-bordered table-condensed table-striped p-0 m-0 dataTable no-footer dtr-inline" id="DataTables_Table_0" role="grid" aria-describedby="DataTables_Table_0_info" style="width: 100%; height: 40%;">
    <thead>
        <tr role="row">
            <th class="sorting_disabled" rowspan="1" colspan="1" style="color: #800000;">Subject</th>
            <th class="sorting_disabled" rowspan="1" colspan="1" style="color: #800000;">Section</th>
            <th class="sorting_disabled" rowspan="1" colspan="1" style="color: #800000;">Semester</th>
            <th class="sorting_disabled" rowspan="1" colspan="1" style="color: #800000;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for classlist in classlists %}
        <tr role="row">
            <td tabindex="0">{{ classlist.subject_name }}</td>
            <td>{{ classlist.section_code }}</td>
            <td>{{ classlist.semester.value }}</td>
            <td>
                <button class="btn btn-primary btn-sm" onclick="downloadAction('{{ classlist.subject_name }}', '{{ classlist.section_code }}')">Download</button>
                <button class="btn btn-danger btn-sm" onclick="deleteAction('{{ classlist.subject_name }}', '{{ classlist.section_code }}')">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function addRow(subject, section, semester) {
    var table = document.getElementById("DataTables_Table_0").getElementsByTagName('tbody')[0];
    var newRow = table.insertRow(table.rows.length);

    var cell1 = newRow.insertCell(0);
    cell1.innerHTML = subject;

    var cell2 = newRow.insertCell(1);
    cell2.innerHTML = section;

    var cell3 = newRow.insertCell(2);
    cell3.innerHTML = semester;

    var cell4 = newRow.insertCell(3);
    cell4.innerHTML = `<button class="btn btn-primary btn-sm" onclick="downloadAction('${subject}', '${section}')">Download</button>
                      <button class="btn btn-danger btn-sm" onclick="deleteAction('${subject}', '${section}')">Delete</button>`;
}

// Call addRow with sample data
addRow("New Subject", "New Section", "New Semester");
</script>

{% endblock %}
